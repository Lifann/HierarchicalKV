# merlin-hkvs

Merlin Hierarchical Key-Value Storage

## How to build with TFRA
```shell
git clone -b rhdong/merlin https://github.com/rhdong/recommenders-addons.git
cd recommenders-addons/tensorflow_recommenders_addons/dynamic_embedding/core/lib/
git clone -b master https://github.com/rhdong/merlin-hkvs.git
cd ../../../../
PY_VERSION="3.8" TF_VERSION="2.5.1" TF_NEED_CUDA=1 sh .github/workflows/make_wheel_Linux_x86.sh
```

wheel file will be created in the [TFRA root]/wheelhouse/

## benchmark

### Merlin
* Update time: June 1, 2022
* version: tag [v0.2.0](https://github.com/rhdong/merlin-hkvs/releases/tag/v0.2.0)

* Unit: Million-KV/second
* CPU: libcuckoo
* nvhash: pure HBM
* MKVS-B: Before Optimized
* MKVS-C: After Optimized


|   dim |   keys num |   test_times | CPU     |  nvhash | MKVS-B | MKVS-C | CPU     |  nvhash  | MKVS-B  | MKVS-C  | 
|       |            |              | upsert  |  upsert | upsert | upsert | lookup  |  lookup  | lookup  | lookup  | 
|-------|------------|--------------|---------|---------|--------|--------|---------|----------|---------|---------|
|     8 |       1024 |           20 | -32.661 |   0.704 |  3.947 |  0.948 | -29.188 |    4.923 |   3.563 |   1.063 |
|     8 |       8192 |           20 |  31.775 |   4.321 | 15.327 |  4.982 |  19.912 |    9.708 |  18.528 |   6.071 |
|     8 |      16384 |           20 |  31.812 |  12.159 | 20.468 |  8.896 |  23.018 |  675.708 |  36.701 |  11.478 |
|     8 |      32768 |           20 |  93.662 |  22.393 | 24.272 | 16.089 |  33.189 |  416.292 |  68.396 |  21.736 |
|     8 |      65536 |           20 |  38.731 |  41.261 | 26.737 | 25.399 |  21.126 |  417.335 |  90.201 |  36.718 |
|     8 |     131072 |           20 |  40.009 |  80.422 | 27.271 | 34.255 |  21.653 |  204.309 |  98.046 |  62.262 |
|     8 |    1048576 |           20 |  31.708 | 304.959 | 23.489 | 34.769 |  18.142 |  440.483 | 156.049 | 155.36  |
|    64 |       1024 |           20 |   7.865 |   0.563 |  3.897 |  0.904 |   2.291 |   17.232 |   2.401 |   1.026 |
|    64 |       8192 |           20 |   9.3   |   4.683 | 11.733 |  4.761 |   1.803 |   46.959 |  17.025 |   6.134 |
|    64 |      16384 |           20 |   9.346 |   9.099 | 16.462 | 10.517 |   1.783 |   45.991 |  25.578 |   9.911 |
|    64 |      32768 |           20 |  11.438 |  17.117 | 18.678 | 16.514 |   2.548 |   44.505 |  30.226 |  17.237 |
|    64 |      65536 |           20 |  12.796 |  27.293 | 20.54  | 19.378 |   3.074 |   38.849 |  41.477 |  22.46  |
|    64 |     131072 |           20 |  13.302 |  56.027 | 19.989 | 25.161 |   3.143 |   56.098 |  46.403 |  30.352 |
|    64 |    1048576 |           20 |  10.858 | 162.962 | 17.446 | 27.148 |   2.641 |   75.714 |  59.096 |  54.025 |
|   128 |       1024 |           20 |   0.784 |   0.373 |  3.783 |  1.151 |   0.782 |    1.065 |   2.509 |   0.734 |
|   128 |       8192 |           20 |   5.001 |   3.602 | 14.173 |  4.502 |   3.204 |   24.895 |  18.356 |   4.346 |
|   128 |      16384 |           20 |   4.376 |   5.313 | 16.755 |  9.747 |   2.292 |   12.334 |  21.545 |   6.309 |
|   128 |      32768 |           20 |   4.81  |  13.742 | 18.733 | 15.501 |   2.471 |   27.061 |  21.577 |  10.668 |
|   128 |      65536 |           20 |   5.057 |  22.744 | 19.039 | 19.697 |   3.013 |   26.216 |  23.784 |  19.289 |
|   128 |     131072 |           20 |   4.909 |  31.414 | 19.158 | 22.384 |   2.289 |   27.607 |  28.84  |  21.455 |
|   128 |    1048576 |           20 |   4.686 |  93.366 | 16.914 | 21.407 |   2.695 |   36.501 |  37.198 |  33.686 |