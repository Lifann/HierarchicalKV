# merlin-hkvs

Merlin Hierarchical Key-Value Storage

## How to build with TFRA
```shell
git clone -b rhdong/merlin https://github.com/rhdong/recommenders-addons.git
cd recommenders-addons/tensorflow_recommenders_addons/dynamic_embedding/core/lib/
git clone -b master https://github.com/rhdong/merlin-hkvs.git
cd ../../../../
PY_VERSION="3.8" TF_VERSION="2.5.1" TF_NEED_CUDA=1 sh .github/workflows/make_wheel_Linux_x86.sh
```

wheel file will be created in the [TFRA root]/wheelhouse/

## benchmark

### Merlin
* Update time: May 24, 2022
* version: tag [v0.1.0](https://github.com/rhdong/merlin-hkvs/releases/tag/v0.1.0)
* Unit: M keys/s 
* `cudf::nvhash` run on pure HBM mode.
* `Merlin-HKVS-A` run on pure HBM mode.
* `Merlin-HKVS-B` run on HBM+HMEM mode.

|   dim |   keys num |   test_times | CPU.upsert |   cudf::nvhash.upsert | Merlin-HKVS-A.upsert | Merlin-HKVS-B.upsert | CPU.lookup  | cudf::nvhash.lookup  | Merlin-HKVS-A.lookup | Merlin-HKVS-B.lookup |
|-------|------------|--------------|----------------------|--------------|--------------|---------------------------|--------------|--------------|--------------|-----------------------|
|     8 |       1024 |           20 | 16.596               |        0.715 |       13.254 | 4.612       | 12.658      |        2.104 |        2.619 | 3.146                 |
|     8 |       2048 |           20 | 23.696               |        1.493 |        5.754 | 8.057       | 16.139      |        3.756 |        3.642 | 6.876                 |
|     8 |       4096 |           20 | 26.881               |        2.943 |       10.693 | 7.17        | 23.143      |        9.017 |        4.467 | 6.674                 |
|     8 |       8192 |           20 | 27.505               |        6.088 |       29.531 | 11.368      | 23.709      |       58.594 |       28.112 | 16.724                |
|     8 |      16384 |           20 | 29.602               |       12.311 |       42.968 | 20.523      | 17.047      |       42.756 |       52.476 | 43.032                |
|     8 |      10000 |           20 | 14.383               |        6.449 |       23.841 | 16.887      | 20.867      |       36.12  |       27.196 | 26.906                |
|     8 |      20000 |           20 | 37.053               |       10.446 |       47.253 | 20.82       | 21.245      |       30.5   |       58.845 | 45.891                |
|     8 |      25000 |           20 | 36.594               |       13.393 |       56.093 | 23.135      | 21.948      |       47.939 |       46.797 | 63.604                |
|     8 |      30000 |           20 | 35.966               |       16.264 |       52.558 | 25.347      | 17.712      |       39.011 |       78.058 | 77.569                |
|     8 |      32768 |           20 | 30.714               |       23.052 |       52.248 | 19.283      | 16.036      |      111.985 |       85.115 | 23.548                |
|     8 |      65536 |           20 | 26.499               |       42.207 |       57.458 | 26.422      | 20.121      |      120.052 |      139.841 | 50.159                |
|     8 |     131072 |           20 | 33.668               |       75.843 |       53.859 | 25.718      | 20.936      |      133.2   |      166.899 | 62.878                |
|     8 |    1048576 |           20 | 25.652               |      386.433 |       37.335 | 23.178      | 9.698       |      615.525 |      227.989 | 148.813               |
|    64 |       1024 |           20 | 2.032                |        0.668 |        5.072 | 5.607       | 1.035       |        2.571 |        3.958 | 3.844                 |
|    64 |       2048 |           20 | 5.67                 |        1.22  |        9.766 | 5.378       | 2.211       |        8.935 |        6.856 | 6.704                 |
|    64 |       4096 |           20 | 5.681                |        2.454 |       19.56  | 5.048       | 2.678       |        6.37  |       15.05  | 3.23                  |
|    64 |       8192 |           20 | 9.933                |        4.824 |       33.19  | 8.115       | 1.51        |       30.624 |       19.276 | 5.937                 |
|    64 |      16384 |           20 | 10.081               |        9.07  |       43.079 | 13.833      | 2.074       |       21.365 |       40.462 | 14.078                |
|    64 |      10000 |           20 | 6.601                |        5.597 |       18.945 | 12.394      | 1.589       |       80.52  |       18.669 | 10.118                |
|    64 |      20000 |           20 | 10.384               |       10.891 |       50.218 | 16.086      | 1.995       |       70.41  |       46.32  | 16.043                |
|    64 |      25000 |           20 | 10.566               |       13.55  |       42.216 | 15.872      | 2.254       |       52.258 |       46.049 | 15.757                |
|    64 |      30000 |           20 | 11.073               |       16.237 |       64.176 | 20.805      | 2.536       |       42.758 |       29.259 | 22.852                |
|    64 |      32768 |           20 | 12.219               |       17.796 |       51.808 | 18.093      | 2.587       |       74.905 |       42.692 | 23.547                |
|    64 |      65536 |           20 | 11.485               |       31.12  |       48.566 | 20.93       | 3.081       |       52.28  |       31.862 | 38.798                |
|    64 |     131072 |           20 | 12.582               |       53.667 |       50.757 | 19.664      | 2.947       |       52.039 |       51.93  | 44.415                |
|    64 |    1048576 |           20 | 10.992               |      166.021 |       36.72  | 17.318      | 2.646       |       76.514 |       70.447 | 58.597                |
